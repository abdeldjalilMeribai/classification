<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeartAI - Prédiction</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='images/icone.png') }}" type="image/png">
</head>
<body>

    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">Heart<span>AI</span></div>
            <div class="sidebar-icon"><i class="fas fa-heartbeat"></i></div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="tabs">
                <a href="/" class="tab" data-route="home">Mon Cœur</a>
                <a href="/analysis" class="tab" data-route="analysis">En savoir plus</a>
                <a href="/predict" class="tab active" data-route="predict">Prédiction</a>
                <a href="/chatbot" class="tab" data-route="chatbot">Discussion</a>
            </div>
            <div class="user-controls">
                <div class="user-btn" id="user-btn">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="user-name" id="username-display">Mon Compte</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="section-title">
                Prédiction<br>de risque cardiaque
            </div>
            <div class="prediction-container">
                <!-- Card d'introduction -->
                <div class="prediction-intro">
                    <div class="intro-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="intro-content">
                        <h3>Analyse prédictive avancée</h3>
                        <p>Remplissez le formulaire ci-dessous pour obtenir une évaluation personnalisée de votre risque cardiaque. Notre algorithme analyse plus de 20 facteurs pour fournir une prédiction précise.</p>
                    </div>
                </div>

                <!-- Formulaire de prédiction -->
                <form id="prediction-form" method="POST" action="/predict">
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-number">1</div>
                            <h4>Informations personnelles</h4>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="age"><i class="fas fa-birthday-cake"></i> Âge</label>
                                <input type="number" id="age" name="age" placeholder="20-100 ans" min="20" max="100" required>
                                <div class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">L'âge est un facteur important dans l'évaluation des risques cardiaques</span>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="sex"><i class="fas fa-venus-mars"></i> Sexe</label>
                                <select id="sex" name="sex" required>
                                    <option value="" disabled selected>Sélectionnez</option>
                                    <option value="0">Femme</option>
                                    <option value="1">Homme</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-number">2</div>
                            <h4>Paramètres physiologiques</h4>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="trestbps"><i class="fas fa-tachometer-alt"></i> Pression artérielle (mmHg)</label>
                                <input type="number" id="trestbps" name="trestbps" placeholder="90-200 mmHg" min="90" max="200" required>
                                <div class="range-indicator">
                                    <span>90</span>
                                    <input type="range" min="90" max="200" value="120" disabled>
                                    <span>200</span>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="chol"><i class="fas fa-flask"></i> Cholestérol (mg/dl)</label>
                                <input type="number" id="chol" name="chol" placeholder="100-600 mg/dl" min="100" max="600" required>
                                <div class="value-indicator">
                                    <span class="value-low">Normal</span>
                                    <span class="value-high">Élevé</span>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="thalach"><i class="fas fa-heartbeat"></i> Fréquence cardiaque max</label>
                                <input type="number" id="thalach" name="thalach" placeholder="60-220 bpm" min="60" max="220" required>
                                <div class="heart-rate-visual">
                                    <div class="rate-bar" style="width: 50%;"></div>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="fbs"><i class="fas fa-syringe"></i> Glycémie à jeun</label>
                                <select id="fbs" name="fbs" required>
                                    <option value="" disabled selected>Sélectionnez</option>
                                    <option value="0">≤ 120 mg/dl</option>
                                    <option value="1">> 120 mg/dl</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-number">3</div>
                            <h4>Données cardiaques</h4>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="cp"><i class="fas fa-heart"></i> Type de douleur thoracique</label>
                                <select id="cp" name="cp" required>
                                    <option value="" disabled selected>Sélectionnez</option>
                                    <option value="1">Angine typique</option>
                                    <option value="2">Angine atypique</option>
                                    <option value="3">Douleur non-angineuse</option>
                                    <option value="4">Asymptomatique</option>
                                </select>
                                <div class="pain-visual">
                                    <div class="pain-point" data-value="1"></div>
                                    <div class="pain-point" data-value="2"></div>
                                    <div class="pain-point" data-value="3"></div>
                                    <div class="pain-point" data-value="4"></div>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="restecg"><i class="fas fa-heartbeat"></i> Résultat ECG</label>
                                <select id="restecg" name="restecg" required>
                                    <option value="" disabled selected>Sélectionnez</option>
                                    <option value="0">Normal</option>
                                    <option value="1">Anomalie onde ST-T</option>
                                    <option value="2">Hypertrophie ventriculaire gauche</option>
                                </select>
                                <div class="ecg-preview">
                                    <div class="ecg-line normal"></div>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="exang"><i class="fas fa-running"></i> Angine induite par l'exercice</label>
                                <select id="exang" name="exang" required>
                                    <option value="" disabled selected>Sélectionnez</option>
                                    <option value="0">Non</option>
                                    <option value="1">Oui</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <label for="oldpeak"><i class="fas fa-chart-line"></i> Dépression ST induite</label>
                                <input type="number" step="0.1" id="oldpeak" name="oldpeak" placeholder="0-6.2 mm" min="0" max="6.2" required>
                                <div class="st-depression-visual">
                                    <div class="st-line"></div>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="slope"><i class="fas fa-chart-area"></i> Pente du segment ST</label>
                                <select id="slope" name="slope" required>
                                    <option value="" disabled selected>Sélectionnez</option>
                                    <option value="1">Montante</option>
                                    <option value="2">Plate</option>
                                    <option value="3">Descendante</option>
                                </select>
                                <div class="slope-visual">
                                    <div class="slope up"></div>
                                    <div class="slope flat"></div>
                                    <div class="slope down"></div>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="ca"><i class="fas fa-vial"></i> Vaisseaux colorés (0-3)</label>
                                <select id="ca" name="ca" required>
                                    <option value="" disabled selected>Sélectionnez</option>
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                                <div class="vessels-visual">
                                    <div class="vessel" data-visible="false"></div>
                                    <div class="vessel" data-visible="false"></div>
                                    <div class="vessel" data-visible="false"></div>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label for="thal"><i class="fas fa-dna"></i> Thalassémie</label>
                                <select id="thal" name="thal" required>
                                    <option value="" disabled selected>Sélectionnez</option>
                                    <option value="3">Normal</option>
                                    <option value="6">Défaut fixe</option>
                                    <option value="7">Défaut réversible</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="reset-form">
                            <i class="fas fa-redo"></i> Réinitialiser
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-heartbeat"></i> Analyser
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Résultat de l'analyse -->
    <div id="result-container" class="result-container" style="display: none;">
        <div class="result-header">
            <h3>Résultat de l'analyse</h3>
            <button id="close-result"><i class="fas fa-times"></i></button>
        </div>
        <div id="diagnosis-result" class="diagnosis-result">
            <!-- Contenu généré dynamiquement -->
        </div>
        <div class="medical-details">
            <h4>Détails médicaux</h4>
            <div id="medical-values" class="values-grid">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
        <div class="recommendations">
            <h4>Recommandations</h4>
            <div id="recommendations-list"></div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page prediction chargée');
        checkAuthenticationStatus();
        setupUserMenu();
        initializePredictionForm();
    });

    function checkAuthenticationStatus() {
        console.log('Vérification de l authentification...');
        
        fetch('/check_auth')
            .then(response => {
                console.log('Réponse reçue:', response.status);
                if (!response.ok) {
                    throw new Error('Erreur HTTP: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Données reçues:', data);
                if (data.authenticated) {
                    console.log('Utilisateur authentifié:', data.username);
                    if (data.username) {
                        document.getElementById('username-display').textContent = data.username;
                    }
                } else {
                    console.log('Non authentifié, redirection...');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Erreur de vérification auth:', error);
                window.location.href = '/login';
            });
    }

    function setupUserMenu() {
        // Création du menu compact
        const userMenu = document.createElement('div');
        userMenu.className = 'user-menu-compact';
        userMenu.innerHTML = `
            <a href="/" class="user-link"><i class="fas fa-user"></i> Mon profil</a>
            <a href="/analysis" class="user-link"><i class="fas fa-heartbeat"></i> En savoir plus</a>
            <a href="/predict" class="user-link"><i class="fas fa-chart-line"></i> Prédiction</a>
            <a href="/chatbot" class="user-link"><i class="fas fa-comments"></i> Discussion</a>
            <a href="#" class="user-link" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
        `;
        
        const userControls = document.querySelector('.user-controls');
        if (userControls) {
            userControls.appendChild(userMenu);
        }

        // Gestion du bouton utilisateur
        const userBtn = document.getElementById('user-btn');
        if (userBtn) {
            userBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('active');
                userMenu.classList.toggle('show');
            });
        }

        // Fermeture du menu
        document.addEventListener('click', function() {
            if (userBtn) userBtn.classList.remove('active');
            if (userMenu) userMenu.classList.remove('show');
        });

        if (userMenu) {
            userMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // Déconnexion
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                fetch('/logout')
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(error => {
                        console.error('Erreur de déconnexion:', error);
                        window.location.href = '/login';
                    });
            });
        }
    }

    function initializePredictionForm() {
        console.log('Initialisation du formulaire de prédiction');
        
        // Réinitialisation du formulaire
        const resetBtn = document.getElementById('reset-form');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                document.getElementById('prediction-form').reset();
                updateVisualIndicators();
                console.log('Formulaire réinitialisé');
            });
        }

        // Mise à jour des indicateurs visuels
        document.querySelectorAll('#prediction-form input, #prediction-form select').forEach(element => {
            element.addEventListener('change', updateVisualIndicators);
            element.addEventListener('input', updateVisualIndicators);
        });

        // Soumission du formulaire
        const predictionForm = document.getElementById('prediction-form');
        if (predictionForm) {
            predictionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitForm(e);
            });
        }

        // Initialiser les indicateurs visuels
        updateVisualIndicators();
    }

    function updateVisualIndicators() {
        console.log('Mise à jour des indicateurs visuels');
        
        try {
            // Fréquence cardiaque
            const thalach = document.getElementById('thalach').value;
            if (thalach) {
                const ratePercent = ((thalach - 60) / (220 - 60)) * 100;
                const rateBar = document.querySelector('.rate-bar');
                if (rateBar) {
                    rateBar.style.width = `${Math.max(0, Math.min(100, ratePercent))}%`;
                }
            }

            // Vaisseaux colorés
            const ca = document.getElementById('ca').value;
            if (ca) {
                document.querySelectorAll('.vessels-visual .vessel').forEach((vessel, index) => {
                    vessel.dataset.visible = index < parseInt(ca);
                });
            }

            // Type de douleur
            const cp = document.getElementById('cp').value;
            if (cp) {
                document.querySelectorAll('.pain-point').forEach(point => {
                    point.style.opacity = point.dataset.value === cp ? '1' : '0.3';
                });
            }

            // Dépression ST
            const oldpeak = document.getElementById('oldpeak').value;
            if (oldpeak) {
                const stHeight = Math.min(20, oldpeak * 5);
                const stLine = document.querySelector('.st-line');
                if (stLine) {
                    stLine.style.height = `${stHeight}px`;
                    stLine.style.bottom = `calc(50% - ${stHeight/2}px)`;
                }
            }

            // Pente ST
            const slope = document.getElementById('slope').value;
            if (slope) {
                document.querySelectorAll('.slope').forEach(slopeEl => {
                    slopeEl.style.opacity = '0.3';
                });
                const slopeClass = getSlopeClass(slope);
                if (slopeClass) {
                    const targetSlope = document.querySelector(`.slope.${slopeClass}`);
                    if (targetSlope) {
                        targetSlope.style.opacity = '1';
                    }
                }
            }
        } catch (error) {
            console.error('Erreur dans updateVisualIndicators:', error);
        }
    }

    function getSlopeClass(slopeValue) {
        switch(slopeValue) {
            case '1': return 'up';
            case '2': return 'flat';
            case '3': return 'down';
            default: return '';
        }
    }

    function submitForm(event) {
        console.log('Soumission du formulaire');
        event.preventDefault();
        
        const form = document.getElementById('prediction-form');
        const formData = new FormData(form);

        // Validation des champs requis
        let isValid = true;
        const requiredFields = ['age', 'sex', 'trestbps', 'chol', 'thalach', 'fbs', 'cp', 'restecg', 'exang', 'oldpeak', 'slope', 'ca', 'thal'];
        
        requiredFields.forEach(field => {
            const input = document.getElementById(field);
            if (!input.value) {
                isValid = false;
                input.style.borderColor = '#ff4d79';
            } else {
                input.style.borderColor = '';
            }
        });

        if (!isValid) {
            alert('Veuillez remplir tous les champs obligatoires.');
            return;
        }

        // Afficher un indicateur de chargement
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse en cours...';
        submitBtn.disabled = true;

        fetch('/predict', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.redirect) {
                window.location.href = data.redirect;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de l\'analyse. Veuillez réessayer.');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }
</script>
</body>
</html>