<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeartAI - Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='images/icone.png') }}" type="image/png">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">Heart<span>AI</span></div>
            <div class="sidebar-icon"><i class="fas fa-heartbeat"></i></div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="tabs">
                <a href="/" class="tab" data-route="home">Mon Cœur</a>
                <a href="/analysis" class="tab" data-route="analysis">En savoir plus</a>
                <a href="/predict" class="tab" data-route="predict">Prédiction</a>
                <a href="/chatbot" class="tab active" data-route="chatbot">Discussion</a>
            </div>
            <div class="user-controls">
                <div class="user-btn" id="user-btn">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="user-name" id="username-display">Mon Compte</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="section-title">
                Assistant Virtuel<br>HeartAI
            </div>

            <div class="chatbot-container">
                <div class="chatbot-header">
                    <div class="chatbot-avatar">
                        <div class="heart-pulse"></div>
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="chatbot-info">
                        <h3>HeartAI Assistant</h3>
                        <p>Spécialiste en santé cardiaque</p>
                    </div>
                    
                    <div class="chatbot-status">
                        <span class="status-dot"></span>
                        <span>En ligne</span>
                    </div>
                </div>

                <div class="chatbot-messages" id="chat-messages">
                    <!-- Messages will appear here -->
                    <div class="message bot-message">
                        <div class="message-avatar">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                Bonjour ! Je suis HeartAI, votre assistant en santé cardiaque. Comment puis-je vous aider aujourd'hui ?
                            </div>
                            <div class="message-time">12:45</div>
                        </div>
                    </div>
                </div>

                <div class="chatbot-input">
                    <div class="input-group">
                        <input type="text" id="user-input" placeholder="Posez votre question sur la santé cardiaque...">
                        <button id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="suggestions">
                        <span class="suggestion">Quels sont les symptômes d'une crise cardiaque ?</span>
                        <span class="suggestion">Comment réduire mon cholestérol ?</span>
                        <span class="suggestion">Quels exercices sont bons pour le cœur ?</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page chatbot chargée');
        checkAuthenticationStatus();
        setupUserMenu();
    });

    function checkAuthenticationStatus() {
        console.log('Vérification de l authentification...');
        
        fetch('/check_auth')
            .then(response => {
                console.log('Réponse reçue:', response.status);
                if (!response.ok) {
                    throw new Error('Erreur HTTP: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Données reçues:', data);
                if (data.authenticated) {
                    console.log('Utilisateur authentifié:', data.username);
                    if (data.username) {
                        document.getElementById('username-display').textContent = data.username;
                    }
                    initializeChatbot();
                } else {
                    console.log('Non authentifié, redirection...');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Erreur de vérification auth:', error);
                window.location.href = '/login';
            });
    }

    function setupUserMenu() {
        // Création du menu compact
        const userMenu = document.createElement('div');
        userMenu.className = 'user-menu-compact';
        userMenu.innerHTML = `
            <a href="/" class="user-link"><i class="fas fa-user"></i> Mon profil</a>
            <a href="/analysis" class="user-link"><i class="fas fa-heartbeat"></i> En savoir plus</a>
            <a href="/predict" class="user-link"><i class="fas fa-chart-line"></i> Prédiction</a>
            <a href="/chatbot" class="user-link"><i class="fas fa-comments"></i> Discussion</a>
            <a href="#" class="user-link" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
        `;
        
        const userControls = document.querySelector('.user-controls');
        if (userControls) {
            userControls.appendChild(userMenu);
        }

        // Gestion du bouton utilisateur
        const userBtn = document.getElementById('user-btn');
        if (userBtn) {
            userBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('active');
                userMenu.classList.toggle('show');
            });
        }

        // Fermeture du menu
        document.addEventListener('click', function() {
            if (userBtn) userBtn.classList.remove('active');
            if (userMenu) userMenu.classList.remove('show');
        });

        if (userMenu) {
            userMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // Déconnexion
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                fetch('/logout')
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(error => {
                        console.error('Erreur de déconnexion:', error);
                        window.location.href = '/login';
                    });
            });
        }
    }

    function initializeChatbot() {
        console.log('Initialisation du chatbot');
        
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const suggestions = document.querySelectorAll('.suggestion');

        // Function to add a message to the chat
        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message bot-message';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-heartbeat"></i>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = text;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            const now = new Date();
            timeDiv.textContent = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
            
            contentDiv.appendChild(textDiv);
            contentDiv.appendChild(timeDiv);
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to show typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message bot-message typing';
            typingIndicator.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingIndicator;
        }

        // Function to remove typing indicator
        function removeTypingIndicator(indicator) {
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }

        async function sendToGemini(message) {
            let typingIndicator = null;
            try {
                // Show typing indicator
                typingIndicator = showTypingIndicator();

                // Replace with your actual Gemini API key
                const API_KEY = 'AIzaSyBqrGgd1lvSlT_iLOH9_U0QKHdNx0oY_hM';
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': API_KEY
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [{
                                text: `Tu es un assistant spécialisé en santé cardiaque nommé HeartAI. Réponds de manière professionnelle et bienveillante en français. Voici la question: ${message}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topP: 1,
                            topK: 1,
                            maxOutputTokens: 2048
                        }
                    })
                });

                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator(typingIndicator);
                
                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    console.error('API Response:', data);
                    return "Je n'ai pas pu traiter votre demande. Veuillez reformuler votre question.";
                }
            } catch (error) {
                // Remove typing indicator in case of error
                removeTypingIndicator(typingIndicator);
                console.error('Error calling Gemini API:', error);
                return "Une erreur s'est produite lors de la connexion au service. Veuillez réessayer plus tard.";
            }
        }

        // Event listener for send button
        sendButton.addEventListener('click', async function() {
            const message = userInput.value.trim();
            if (message) {
                addMessage(message, true);
                userInput.value = '';
                
                const response = await sendToGemini(message);
                addMessage(response, false);
            }
        });

        // Event listener for Enter key
        userInput.addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const message = userInput.value.trim();
                if (message) {
                    addMessage(message, true);
                    userInput.value = '';
                    
                    const response = await sendToGemini(message);
                    addMessage(response, false);
                }
            }
        });

        // Event listeners for suggestion buttons
        suggestions.forEach(suggestion => {
            suggestion.addEventListener('click', async function() {
                const message = this.textContent;
                userInput.value = message;
                
                // Auto-send the suggestion
                addMessage(message, true);
                userInput.value = '';
                
                const response = await sendToGemini(message);
                addMessage(response, false);
            });
        });

        // Add CSS for typing indicator
        const style = document.createElement('style');
        style.textContent = `
            .typing-indicator {
                display: flex;
                gap: 4px;
                padding: 12px 16px;
            }
            
            .typing-indicator span {
                width: 8px;
                height: 8px;
                background: #ccc;
                border-radius: 50%;
                display: inline-block;
                animation: typing 1.4s infinite ease-in-out;
            }
            
            .typing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }
            
            .typing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }
            
            @keyframes typing {
                0%, 60%, 100% { transform: translateY(0); }
                30% { transform: translateY(-5px); }
            }
        `;
        document.head.appendChild(style);
    }
</script>
</body>
</html>